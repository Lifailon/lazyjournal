name: Linters check and fix

on:
  workflow_dispatch:
    inputs:
      Update:
        description: 'Update dependencies in modules'
        default: false
        type: boolean
      Fix:
        description: 'Golangci linters fix'
        default: false
        type: boolean
      PR:
        description: 'Create Pull Request'
        default: false
        type: boolean
      Golangci:
        description: 'Golangci linters check'
        default: false
        type: boolean
      Gocrit:
        description: 'Go critical linters check'
        default: false
        type: boolean
      Gosec:
        description: 'Go security linters check'
        default: false
        type: boolean

jobs:
  lint:
    name: Linters check

    permissions:
      contents: read

    runs-on: ubuntu-latest

    env:
      APP_VERSION: "latest"

    steps:
      - name: Checkout repository (main branch and 1 last commits)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25

      - name: Install dependencies
        run: |
          go fmt ./...
          go vet ./...
          go get ./...
          go mod tidy
          go mod verify
          go build -v ./...

      - name: Get app version in env
        run: |
          APP_VERSION=$(go run main.go -v)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      - name: Update dependencies in modules
        if: ${{ github.event.inputs.Update == 'true' }}
        run: go get -u ./...

      - name: Create Pull Request for update dependencies
        if: ${{ github.event.inputs.Update == 'true' && github.event.inputs.PR == 'true' }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "actions: update dependencies"
          branch: "fix/${{ env.APP_VERSION }}-update"
          title: "Updated dependencies (modules)"
          body: "Updated dependencies in the `go.mod` and `go.sum` files."
          add-paths: |
            go.mod
            go.sum

      - name: Install golangci
        if: ${{ github.event.inputs.Fix == 'true'|| github.event.inputs.golangci == 'true' }}
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0

      - name: Golangci linters fix in main.go
        if: ${{ github.event.inputs.Fix == 'true' }}
        run: golangci-lint run --fix ./main.go

      - name: Create Pull Request for fix lint
        if: ${{ github.event.inputs.Fix == 'true' && github.event.inputs.PR == 'true' }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "actions: fix lint in main.go"
          branch: "fix/${{ env.APP_VERSION }}-lint"
          title: "Fixed linters"
          body: "Automatically fixing linters with golangci from GitHub Actions."
          add-paths: |
            main.go

      - name: Golangci lint action
        id: golangci
        if: ${{ github.event.inputs.golangci == 'true' }}
        continue-on-error: true
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8.0
          args: -v ./main.go

      # - name: Golangci linters check
      #   id: golangci
      #   if: ${{ github.event.inputs.golangci == 'true' }}
      #   continue-on-error: true
      #   run: golangci-lint run --out-format=github-actions -v ./main.go # --no-config --enable-all

      - name: Go critical linters check
        id: gocrit
        if: ${{ github.event.inputs.gocrit == 'true' }}
        continue-on-error: true
        run: |
          go install github.com/go-critic/go-critic/cmd/gocritic@latest
          gocritic check -v -enableAll ./main.go

      - name: Go security linters check
        id: gosec
        if: ${{ github.event.inputs.gosec == 'true' }}
        continue-on-error: true
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -severity=high ./...

      - name: Send report to Telegram
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          debug: true
          format: markdown
          message: |
            ğŸ”” **Action**: linters check and fix

            ğŸ“ **Repository**: ${{ github.repository }}
            ğŸ‘¤ **User**: ${{ github.actor }}
            
            Parameters:
            **Update dependencies in `go.mod`**: ${{ github.event.inputs.Update == 'true' && 'âœ…' || 'âŒ' }}
            **Golangci linters fix in `main.go`**: ${{ github.event.inputs.Fix == 'true' && 'âœ…' || 'âŒ' }}
            **Create Pull Request**: ${{ github.event.inputs.PR == 'true' && 'âœ…' || 'âŒ' }}
            **Golangci linters check**: ${{ github.event.inputs.Golangci == 'true' && 'âœ…' || 'âŒ' }}
            **Go critical linters check**: ${{ github.event.inputs.Gocrit == 'true' && 'âœ…' || 'âŒ' }}
            **Go security linters check**: ${{ github.event.inputs.Gosec == 'true' && 'âœ…' || 'âŒ' }}

            Results:
            ${{ steps.golangci.outcome == 'failure' && 'âŒ' || 'âœ…' }} **Golangci linters check**: ${{ steps.golangci.outcome }}
            ${{ steps.gocrit.outcome == 'failure' && 'âŒ' || 'âœ…' }} **Go critical linters check**: ${{ steps.gocrit.outcome }}
            ${{ steps.gosec.outcome == 'failure' && 'âŒ' || 'âœ…' }} **Go security linters check**: ${{ steps.gosec.outcome }}