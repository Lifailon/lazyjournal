name: AI Issue Analysis

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  issue_analysis:
    permissions:
      issues: write
      models: read

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send message to Telegram
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_TO_CHANNEL }}
          format: html
          debug: true
          message: |
            ğŸ”” <b>Action</b>: ${{ github.event_name }} (${{ github.event.action }})

            ğŸ“ <b>Repository</b>: ${{ github.repository }}
            ğŸ‘¤ <b>From user</b>: ${{ github.actor }}
            ğŸ”— <a href="${{ github.event.comment.html_url || github.event.issue.html_url }}">Open an issue on GitHub</a>

            ğŸ“Œ <b>Title</b>: ${{ github.event.issue.title }}
            ğŸ’¬ <b>Description</b>:
            ${{ github.event.comment.body || github.event.issue.body }}

      - name: Generate report using AI
        if: github.event_name == 'issues' && github.event.action == 'opened'
        id: ai_query
        uses: actions/ai-inference@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          endpoint: https://models.github.ai/inference
          model: gpt-4.1
          max-tokens: 1024
          system-prompt: |
            You are a developer assistant.
            Your job is to analyze issues on GitHub and suggest solutions.
            Your responses should be brief and in English.
          prompt: |
            Title: ${{ github.event.issue.title }}
            Description: ${{ github.event.issue.body }}

      - name: Post comment from AI
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ steps.ai_query.outputs.response }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "$AI_RESPONSE"