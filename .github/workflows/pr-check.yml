name: PR check and AI review

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  pull_request_review_comment:
    types: [created]

run-name: "${{ github.event_name == 'workflow_dispatch' && 'Unit testing only' || format('‚úÖ Pull Request #{0}: {1}', github.event.pull_request.number, github.event.pull_request.title) }}"

jobs:
  pr_tg_report:
    name: Telegram report

    if: ${{ github.event_name == 'pull_request' }}

    runs-on: ubuntu-latest

    steps:
      - name: Send message to Telegram
        id: tg_msg
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          debug: true
          format: markdown
          message: |
            üîî **Action**: ${{ github.event_name }} ${{ github.event.action }} [#${{ github.event.pull_request.number }}](${{ github.event.comment.html_url || github.event.pull_request.html_url }})

            üìÅ **Repository**: ${{ github.repository }}
            üåø **Branch**: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}
            üë§ **From user**: ${{ github.actor }}

            üìå **Title**: ${{ github.event.pull_request.title }}
            üí¨ **Description**:
            ${{ github.event.comment.body || github.event.pull_request.body }}

      - name: Send action and title only to Telegram (if error sending description)
        if: ${{ steps.tg_msg.outcome == 'failure' }}
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          debug: true
          format: markdown
          message: |
            üîî **Action**: ${{ github.event_name }} ${{ github.event.action }} [#${{ github.event.pull_request.number }}](${{ github.event.comment.html_url || github.event.pull_request.html_url }})

            üìÅ **Repository**: ${{ github.repository }}
            üåø **Branch**: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}
            üë§ **From user**: ${{ github.actor }}

            üìå **Title**: ${{ github.event.pull_request.title }}

  pr_unit_test:
    name: Unit testing

    if: ${{ (github.event_name == 'pull_request' && github.event.action == 'opened') || github.event_name == 'workflow_dispatch' }}

    permissions:
      pull-requests: write
      contents: read
      models: read
      checks: write

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (merge branch and 1 last commits)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25

      - name: Install dependencies
        run: |
          go fmt ./...
          go vet ./...
          go get ./...
          go mod tidy
          go mod verify
          go build -v ./...

      - name: Start docker container
        run: |
          version=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | jq -r .tag_name)
          curl -sSL "https://github.com/docker/compose/releases/download/$version/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
          sed "s/TTYD=false/TTYD=true/" docker-compose.yml -i
          docker-compose up -d
          docker run -d --name pinguem -p 8085:8085 -p 3005:3005 lifailon/pinguem:latest

      - name: Create pcap files
        run: |
          sudo tcpdump -i any -c 1 -w test.pcap
          gzip -c test.pcap > test.pcap.gz
          sudo tcpdump -i any -c 1 -w test.pcapng
          gzip -c test.pcapng > test.pcapng.gz
          ls -lh

      - name: Install bat and tailspin
        run: |
          sudo apt install bat
          bat --version || batcat --version || true
          version=$(curl -s https://api.github.com/repos/bensadeh/tailspin/releases/latest | jq -r .tag_name)
          curl -L "https://github.com/bensadeh/tailspin/releases/download/$version/tailspin-$(uname -m)-unknown-$(uname -s | tr '[:upper:]' '[:lower:]')-musl.tar.gz" -o /usr/local/bin/tailspin.tar.gz
          tar -xzf /usr/local/bin/tailspin.tar.gz -C /usr/local/bin
          mv /usr/local/bin/tspin /usr/local/bin/tailspin
          chmod +x /usr/local/bin/tailspin
          rm /usr/local/bin/*.tar.gz
          tailspin --version

      - name: Install gotestsum for junit report
        run: go install gotest.tools/gotestsum@latest

      - name: Go unit testing
        id: unitTesting
        timeout-minutes: 10
        run: sudo env "PATH=$PATH" gotestsum --junitfile report.xml -- ./... -v -cover

      - name: Publish junit report in summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: "report.xml"

      - name: Publish junit report in annotations
        uses: mikepenz/action-junit-report@v6
        if: always()
        with:
          report_paths: "report.xml"

      - name: Send message to Telegram
        uses: appleboy/telegram-action@master
        if: always()
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          debug: true
          format: markdown
          message: |
            üîî **Action**: unit testing for pr [#${{ github.event.pull_request.number }}](${{ github.event.comment.html_url || github.event.pull_request.html_url }})

            üìÅ **Repository**: ${{ github.repository }}
            üë§ **From user**: ${{ github.actor }}

            üí° **Result**: ${{ steps.unitTesting.outcome }}

      - name: Post AI comment on PR
        if: ${{ github.event_name == 'pull_request' && always() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SUMMARY=$(cat $GITHUB_STEP_SUMMARY)
          BODY=$(printf "### Unit testing results\n\nStatus: **${{ steps.unitTesting.outcome }}**\n\n$SUMMARY")
          gh pr comment "$PR_NUMBER" --body "$BODY"

  pr_ai_review:
    name: AI review

    needs: [pr_tg_report, pr_unit_test]

    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' }}

    permissions:
      pull-requests: write
      contents: read
      models: read

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (main branch and 1 last commits)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Get PR diff
        id: pr_diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate report using AI
        id: ai_query
        uses: actions/ai-inference@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          endpoint: https://models.github.ai/inference
          model: gpt-4.1
          max-tokens: 2048
          system-prompt: |
            You are a Pull Request Review Agent on GitHub.
            Review the pull request and provide feedback.
            Focus on potential bugs, security issues and code style.
            Responses should be brief and written in English.
          prompt: |
            PR Title: ${{ github.event.pull_request.title }}
            PR Description:
            ${{ github.event.pull_request.body }}

            Code diff:
            ${{ steps.pr_diff.outputs.diff }}
            

      - name: Post AI comment on PR
        if: ${{ steps.ai_query.outputs.response != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AI_RESPONSE: ${{ steps.ai_query.outputs.response }}
        run: |
          gh pr comment "$PR_NUMBER" --body "### AI Code Review
          
          $AI_RESPONSE"