name: AI Pull Request Review

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  pull_request_review_comment:
    types: [created]

run-name: "Pull Request #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"

jobs:
  pr_analysis:
    permissions:
      pull-requests: write
      contents: read
      models: read

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (main branch and 1 last commits)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Send message to Telegram
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          debug: true
          format: markdown
          message: |
            ðŸ”” **Action**: ${{ github.event_name }} ${{ github.event.action }} [#${{ github.event.pull_request.number }}](${{ github.event.comment.html_url || github.event.pull_request.html_url }})

            ðŸ“ **Repository**: ${{ github.repository }}
            ðŸŒ¿ **Branch**: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}
            ðŸ‘¤ **From user**: ${{ github.actor }}

            ðŸ“Œ **Title**: ${{ github.event.pull_request.title }}
            ðŸ’¬ **Description**:
            ${{ github.event.comment.body || github.event.pull_request.body }}

      - name: Get PR diff
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        id: pr_diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate report using AI
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        id: ai_query
        uses: actions/ai-inference@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          endpoint: https://models.github.ai/inference
          model: gpt-4.1
          max-tokens: 2048
          system-prompt: |
            You are a Pull Request Review Agent on GitHub.
            Review the pull request and provide feedback.
            Focus on potential bugs, security issues and code style.
            Responses should be brief and written in English.
          prompt: |
            PR Title: ${{ github.event.pull_request.title }}
            PR Description: ${{ github.event.pull_request.body }}

            Code diff:
            ${{ steps.pr_diff.outputs.diff }}
            

      - name: Post AI Comment on PR
        if: github.event_name == 'pull_request' && github.event.action == 'opened' && steps.ai_query.outputs.response != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AI_RESPONSE: ${{ steps.ai_query.outputs.response }}
        run: |
          gh pr comment "$PR_NUMBER" --body "### AI Code Review
          
          $AI_RESPONSE"